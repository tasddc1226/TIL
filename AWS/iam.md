# AWS IAM
> IAM = Identity and Access Management, Global Service

## IAM의 사용 가능한 구성
- IAM에는 한 사용자는 하나의 조직(Group)에만 속할 수 있다.
- **한 그룹은 다른 그룹을 포함시킬 수 없다. 단지 사용자만 포함할 수 있다.**
- 어떤 사용자가 특정 그룹에 포함되어있지 않는 방법도 가능하지만 추천하는 방법은 아니다.
- **또한 한 사용자는 다른 여러 그룹에 속할 수 있다.**

### 사용자와 그룹을 생성하는 이유?
- AWS 계정을 사용하도록 허용하기 위함이다.
- 그리고 허용을 위해서 이들에게 권한을 부여해야 한다.
- 부여하는 방법으로는 JSON 문서를 통해서 가능하다.

```json
{
    "Version": "2017-10-10",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": "ec2:Describe*",
            "Resource": "*"
        },
        {
            "Effect": "Allow",
            "Action": "elasticloadbalancing:Describe*",
            "Resource": "*"
        }
    ]
}
```

- 어느 특정 유저에게 권한을 너무 많이 설정한다면 큰 비용 또는 보안 문제를 야기할 수 있기 때문에
- AWS는 **최소 권한의 원칙**을 적용해야 한다.
- 사용자가 꼭 필요로 하는 것 이상의 권한을 주지 않도록 해야한다.

## IAM 정책 구조 요소

- 아래의 JSON 형식의 문서를 보고 하나 하나씩 살펴보자.

```json
{
    "Version": "2017-10-17",
    "Id": "S3-Account-Permissions",
    "Statement": [
        {
            "Sid": "1",
            "Effect": "Allow",
            "Principal": {
                "AWS": ["arn:aws:iam::123456789012:root"]
            },
            "Action": [
                "s3:GetObject",
                "s3:PutObject"
            ],
            "Resource": ["arn:aws:s3:::mybucket/*"]
        }
    ]
}
```

- 버전 숫자를 포함한다.
- 정책을 식별하는 `Id`도 존재하지만 선택사항이다.
- 문장(`Statement`)은 하나일 수도 여러 개일 수도 있다.
- `Sid` : 문장 ID로 식별자 (선택사항)
- `effect` : 문장이 특정 API에 접근하는 것을 허용할지 거부할지에 대한 내용이다.
- `Principal` : 특정 정책이 적용될 사용자, 계정, 혹은 역할로 구성된다. (위의 예시에서는 루트 계정에 적용)
- `Action` : `effect`에 기반하여 허용, 거부되는 API 호출 목록이다.
- `Resource` : 적용될 `Action`의 리소스 목록이다.
- `Condition` : `Statement`가 언제 적용될지를 결정하는 조건이 있다. (선택사항이므로  위의 예시에서는 없음)


## IAM - Password Policy
- 유저와 그룹에 대한 정보가 침해당하지 않도록 보호하기 위함.
- 두 가지 방어 메커니즘이 있다. 알아보자

### 1. 비밀번호 정책의 정의
> 비밀번호 정책을 이용하면 계정에 대한 치명적인 공격을 막아내는 데 큰 도움이 된다.

- 비밀번호가 강력할수록 계정의 보안이 철저해짐
- AWS에서는 다양한 옵션을 이용해 비밀번호 정책 생성이 가능
  - 옵션 1 : 비밀번호 최소 길이 설정
  - 옵션 2 : 특정 유형의 글자 사용 요구 (대문자, 소문자, 숫자, 물음표 ..)
- 비밀번호 변경에 대한 허용 또는 금지 가능
- 일정 기간이 지나면 비밀번호를 만료시켜 새 비밀번호 설정 요구
- 사용자가 비밀번호의 재사용을 막아 비밀번호 변경 시에 동일한 비밀번호나 이전에 사용했던 비밀번호를 사용하지 못하도록 함.


### 2. 다요소 인증, MFA(Multi Factor Authentication)
> AWS에서는 비밀번호 이외의 수단으로 이 방법을 필수적으로 사용하도록 권장하고 있다.

- AWS에서의 MFA 장치 옵션?
  - 가상 MFA 장치 : google Authenticator(Only Phone), Authy(PC + Phone)
  - U2F 보안 키 : 유비키(YubiKey), 전자 열쇠 개념
  - 하드웨어 키 팝 MFA 장치 : 차키 같은데 번호가 있음

#### MFA ?
  - MFA는 비밀번호와 가지고있는 보안 장치를 함께 사용하는 것!
  - 장점으로는 비밀번호가 유출되어도 인증 과정에서 본인의 기기(휴대전화)의 물리적인 장치가 추가로 필요해지기 때문에 계정이 보호될 수 있다는 점이다.

---

## IAM Roles for Services(IAM 역할)
> AWS 서비스 몇 가지는 실행하기 위해서 사용자와 마찬가지로 어떤 권한이 필요하다. 따라서, AWS 서비스에 권한을 부여하는 것이 IAM의 역할이다.

- IAM 역할이라는 것을 만들어야 한다.
- `IAM 역할`은 사용자와 같지만 실제 사람이 사용하도록 만들어진 것은 아니고 AWS 서비스에 의해 사용되도록 만들어진 것이다 ???

### 구체적인 예시
- EC2 인스턴스를 만든다고 가정해보자.
- EC2 인스턴스 == 가상 서버
- EC2는 AWS에서 특정 작업을 수행하려고 시도할 수 있다.
- 이때 사용하는 것이 **`IAM 역할`** 이다.
- IAM 역할을 사용해서 권한을 올바르게 부여한 경우 수행하려고 하는 작업에 접근할 수 있다는 의미이다.


---


## IAM 가이드라인 & 모범 사례 소개
- 루트 계정은 AWS 계정을 설정할 때를 제외하고 사용하지 말자.
- 하나의 AWS 사용자는 한 명의 실제 사용자를 의미한다.
- 동료가 우리의 AWS를 이용하고 싶다면 자격 증명을 주지 말고 새로운 사용자를 만들어서 전달해라.
- 그 사용자를 그룹에 넣어 해당 그룹에 권한을 부여할 수 있다.
- 또한 AWS 서비스에 권한을 부여할 때마다 역할을 만드고 사용해야 한다. (가상 서버 EC2 인스턴스 포함)
- 마지막으로 계정의 권한을 감사할 때는 IAM 자격 증명 보고서와 IAM 액세스 분석기를 사용해라.
- `절대로 IAM 사용자와 액세스 키를 공유하지 말 것!`

<br>

## IAM Session 요약

- 회사 내 실제 사용자 == IAM 사용자
- 사용자는 AWS 콘솔에 대한 비밀번호를 갖고 있고, 모범 사례는 사용자를 그룹에 포함시키는 것
- 그룹은 사용자만 포함할 수 있으며 또 다른 그룹은 포함할 수 없음
- IAM 정책(JSON 문서)을 만들어 사용자 or 그룹이 할 수 있는 권한을 알려줌
- AWS에서 역할을 사용할 수 있다. EC2 인스턴스를 생성하거나 AWS 서비스가 다른 AWS 서비스에 특정 작업을 하게 하는 권한을 주려고 할 때 IAM Role을 만들어야 한다.
- 보안 관련해서는 다요소 인증(MFA)를 활성화 하고, 강력한 비밀번호를 만들도록 해야한다.
- IAM 대시보드를 감사하고 싶다면 자격 증명 보고서를 만들어 사용자 관련 정보를 보고, IAM의 특정 사용자를 감사하려면 IAM 액세스 관리자를 사용해서 사용자의 최근 권한에 대한 사용 내역까지 확인할 수 있다.