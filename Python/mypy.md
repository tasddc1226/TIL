# Mypy

> Python에서 3.5 버전부터 Type Hint(타입 어노테이션)에 대한 내용들이 추가되어 동적 언어인 Python을 정적 언어처럼 사용할 수 있게 되었다. `Mypy` 모듈을 사용하면 런타임 내에 오류를 잡는 것이 아니라, 다른 정적 언어의 컴파일러 역할처럼 수행하게 할 수 있다.

## 정적 타입 시스템의 필요성?

- 그러면 타입에 제한이 없는 파이썬을 왜 굳이 정적 타입의 언어들 (Java, C++)처럼 사용하려고 하는 것일까 ?
- 사용자가 점점 많아지면서 안정된 시스템을 위해서는 여러가지 방법들이 존재한다.
  - 분산 처리를 위해 네트워크 장비에 로드밸런서 두기
  - 대역폭 늘리기
  - HA
  - DB 샤딩

- 그 중 한 방법으로는 `정적 타입 시스템`을 도입하는 것이다.

## 타입 시스템?

> 정적 타입시스템을 알아보기 전에 **타입 시스템**이란 무엇인지 알아보자.

- 언어의 기본 타입 또는 개발자가 정의한 타입을 기반으로 해당 타입을 언어와 연관시키는 매커니즘을 의미한다.
- 즉, 타입 동등, 타입 호환, 타입 추론에 대한 규칙을 지키고 있다면 타입 시스템이라고 할 수 있다.

    1. 타입 동등 : 두 타입이 동일할 때 적용되는 규칙
    2. 타입 호환 : 두 타입이 정확히 일치하지 않아도 어느 정도 호환이 되는지를 나타내는 규칙 (any := int)
    3. 타입 추론 : 타입이 정의되어있지 않지만 주변 문맥에 따라 타입이 결정되는 규칙

- 모든 언어는 위의 세 가지 타입 시스템을 가지고 있으며 위에서 설명한 **동적 타입**과 **정적 타입**으로 나누어진다.

## 동적 타입 vs 정적 타입

- 동적 타입은 런타임에 모든 변수의 유형을 걸정하고 잘못된 경우 예외가 발생한다.
- 정적 타입은 컴파일 타임에 모든 변수의 유형을 결정하고 잘못된 경우 예외가 발생한다.


### `정적 타입`을 `정적 타입 시스템`이라고 말할 수 있다. 요즘 추세는 **동적 타입의 언어를 정적 타입의 언어의 특징들을 부여하여 시스템의 안정성을 높이는 것**이다.

---

- 간단한 예시를 통해서 Python에서 어떻게 타입 시스템을 구축하는지 살펴보자.

```py
def create_access_token(data: dict) -> str:
    to_encode = data.copy()

    expire = datetime.utcnow() + timedelta(minutes=ACCESS_TOKEN_EXPIRE_MINUTES)
    to_encode.update({"exp": expire})

    encoded_jwt = jwt.encode(to_encode, SECRET_KEY, algorithm=ALGORITHM)

    return encoded_jwt
```

- 위의 함수는 `딕셔너리` 타입의 `data`라는 값을 인자로 받아와 `문자열`을 리턴하는 함수임을 바로 알 수 있다.
- 이름 까지 자세하게 네이밍 해주었으니, 다른 사람이 작성한 함수여도 금방 이해할 수 있다.
- 이렇게 간단하게도 할 수 있겠지만, `typing` 모듈에는 다양한 타입들을 지원한다. (나중에 천천히 알아볼 예정)

---

## Mypy 모듈

> 이젠 진짜 `Mypy` 모듈에 대하여 알아보도록 하자.

- 서두에서 설명했듯이 `런타임`에 변수의 타입을 결정하는 것이 아니라 `컴파일 타임`에 타입을 검사해주는 역할을 수행할 수 있다.
- 어떻게 사용하는지 우선 설치부터 하자!

```bash
# request에 대한 내용 또한 추가로 검증하기 위해서 types-requests도 설치
> pip install mypy types-requests
```

- `fastapi` 프로젝트의 구조는 간단하게 다음과 같다.

```bash
.
├── Dockerfile
├── LICENSE
├── README.md
├── app
│   ├── core
│   │   └── config.py
│   ├── database.py
│   ├── main.py
│   ├── models.py
│   ├── oauth2.py
│   ├── routers
│   │   ├── auth.py
│   │   ├── like.py
│   │   ├── posts.py
│   │   └── user.py
│   ├── schemas.py
│   ├── user_repository.py
│   └── utils
│       └── password.py
```

- 여기서 `app` 디렉터리에 대한 타입 검사를 아래의 명령어로 실행할 수 있다.

```bash
❯ mypy app --namespace-packages
```

## 실행 결과 화면

<img width="1206" alt="Screen Shot 2022-09-17 at 19 50 49" src="https://user-images.githubusercontent.com/55699007/191033710-df231ab3-b1c7-4444-afda-905f85181ff7.png">

- 실제 fastapi 프로젝트에서 명령어를 실행한 결과이다.
- 생각보다 자세한 위치와 해결할 수 있는 방법들도 힌트처럼 주어진 모습이다.
- 하나 하나 해결해가면서 어떤 부분을 놓치고 있었는지에 대한 내용들도 가지고 갈 수 있었다.
- 천천히 해결해 나아가면서 그 과정도 추가해 볼 예정이다!
